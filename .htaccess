# Enable PHP execution and proper routing
RewriteEngine On

# Force HTTPS and www
RewriteCond %{HTTPS} off [OR]
RewriteCond %{HTTP_HOST} !^www\. [NC]
RewriteCond %{HTTP_HOST} ^(?:www\.)?(.+)$ [NC]
RewriteRule ^(.*)$ https://www.%1/$1 [R=301,L]

# Allow direct access to PHP files in api directory
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d

# Route API calls to the api directory
RewriteRule ^api/(.*)$ api/$1 [L]

# For all other requests that don't match files/directories, serve the React app
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteCond %{REQUEST_URI} !^/api/
RewriteRule ^(.*)$ index.html [L]

# Ensure PHP files are executed, not downloaded
<FilesMatch "\.php$">
    SetHandler application/x-httpd-php
</FilesMatch>

# Security headers
Header always set X-Content-Type-Options nosniff
Header always set X-Frame-Options DENY
Header always set X-XSS-Protection "1; mode=block"

# CORS headers for API endpoints
<LocationMatch "^/api/">
    Header always set Access-Control-Allow-Origin "*"
    Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"
    Header always set Access-Control-Max-Age "3600"
</LocationMatch>

# Handle preflight OPTIONS requests
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^api/(.*)$ api/$1 [L]

# Deny access to sensitive files
<FilesMatch "\.(log|sql|env|config)$">
    Order allow,deny
    Deny from all
</FilesMatch>
